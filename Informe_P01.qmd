---
title: "Estudio de datos biométricos sobre el ciervo volante."
author: 
  - "Olivia Marcos Diaz de Otazu"
  - "Irene Canales Giménez"
  - "Samuel Melián Benito"
date: "20/12/2025" 

format:
  pdf:
    toc: true
    toc-title: "Índice"
    toc-depth: 2
    include-before-body: 
    - text: \newpage
    
geometry: margin=1in
include-in-header:
  - text: |
      \usepackage{fvextra}
      \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
      
execute:
  warning: FALSE
  echo: false
---

```{r}
library(tidyverse)
library(summarytools)
library(GGally)
library(gt)
library(flextable)
library(knitr) 
library(corrplot)
library(ggplot2)
library(dplyr)   
library(kableExtra)
```

\newpage
# Objetivo del estudio
El estudio de Estadística Descriptiva que vamos a realizar tiene como foco el análisis de datos biométricos del **ciervo volante** (*Lucanus cervus*), el mayor escarabajo de Europa y una especie cuya supervivencia está amenazada por la destrucción de su hábitat, bosques con abundancia de madera muerta.

El interés biométrico de esta especie nos lleva a dos preguntas principales:

**Dimorfismo Sexual:** analizaremos si existen diferencias significativas en tamaño entre machos y hembras.

**Influencia del Hábitat:** indagaremos si el tamaño adulto de los ejemplares está correlacionado con la calidad del hábitat de procedencia (Asturias, Cantabria u otra).

Se han tomado medidas en machos y hembras de ciervo volante de tres procedencias, midiendo las variables indicadas en la figura siguiente:
```{r}
knitr::include_graphics("imagenes/imagen.png")
```

El fichero CIERVO.txt recoge, para un total de 265 ejemplares de ciervo volante, parte de estas variables. Concretamente:

– Anchura de la cabeza (KB) expresada en milímetros  
– Longitud de los élitros (EL) también en milímetros  
– Sexo del individuo (hembra o macho)  
– Provincia de procedencia del individuo (Asturias, Cantabria u otra)  

Los objetivos de este estudio son: 

– Realizar un análisis descriptivo de la anchura de la cabeza de una muestra de 150 ejemplares que refleje sus principales características.  
– Comparar la anchura de la cabeza de las hembras con la de los machos.  
– Comparar la anchura de la cabeza de los ejemplares de las tres procedencias.  
– Analizar la correlación entre la anchura de la cabeza y la longitud del élitro para la muestra.  
– Analizar, para cada sexo por separado, la correlación entre la anchura de la cabeza y la longitud del élitro.  
– En caso de que para alguno de los sexos ambas variables estén relacionadas, ajustar una recta de regresión que explique la anchura de la cabeza en función de la longitud del élitro e interpretarla.  

\newpage
# Metodología

El siguiente estudio se basa en un análisis estadístico descriptivo de datos biométricos del ciervo volante (Lucanus cervus). En concreto, en relación a patrones de variación morfológica por sexo y por procedencia de los individuos.

\vspace{1cm}
**Datos y variables**

La muestra global comprende a 265 ejemplares. Sobre ellos se tienen datos de la anchura de la cabeza (KB) y la longitud de los élitros (EL). La procedencia de los ejemplares comprende Asturias, Cantabria, Otras y Desconocida.

En concreto, se espera que la variable KB permita observar el dimorfismo sexual, mientras que la variable EL se toma también como medida representativa del tamaño, global en este caso, del ejemplar. Por tanto, se espera también una posible relación entre ambas variables

\vspace{1cm}
**Selección de la muestra**

Se tomará una muestra de 150 ejemplares, de forma que sea una selección representativa del total de la población. Se hará de forma arbitraria y empleando una semilla para asegurar la aleatoriedad y evitar posibles sesgos. 

\vspace{1cm}
**Análisis estadístico**

Para comenzar se llevará a cabo un análisis descriptivo para la anchura de la cabeza (KB) para la muestra escogida. En concreto, se analizarán los estadísticos siguientes: media, mediana, cuartiles, desviación típica, rango intercuartílico y valores extremos.

Esto permitirá llevar a cabo una comparación entre machos y hembras, así como un estudio en función del hábitat. A través de las tablas y gráficos adecuado, se buscará observar diferencias según las variables, así como dispersión y valores atípicos.

A continuación, un análisis entre ambas variables: anchura de la cabeza (KB) y longitud de los élitros (EL). El objetivo será encontrar una posible correlación y observar su dispersión. Se llevará cabo sobre la muestra, y por sexo.

Para terminar, se empleará regresión lineal entre las variables para explicar la influencia de una sobre los valores de la otra, y se interpretarán los coeficientes obtenidos para ello. 

Todo este estudio se realizará a través del software R.

\newpage
# Resultados

<!--Primero leemos el dataset y transformamos las provincias en blanco en "Desconocida"-->

```{r, echo = FALSE}
datos <- read.table("./datos/CIERVO.txt", fill=TRUE, dec = ",", na.strings = c("", "NA"), header=TRUE );

datos$PROVINCIA[is.na(datos$PROVINCIA)] <- "Desconocida"

datos$SEXO <- factor(datos$SEXO, levels = c("hembra", "macho"))
datos$PROVINCIA <- factor(datos$PROVINCIA, levels = c("Asturias", "Cantabria", "Otras", "Desconocida"))
```

## Análisis de la anchura de la cabeza de los individuos de la muestra

<!--Ahora pasemos a realizar un análisis descriptivo de la anchura de la cabeza de una muestra de 150 ejemplares elegidos de manera aleatoria, reflejando sus principales características-->

```{r}
set.seed(78) #Semilla para asegurar la aleatoriedad a la hora de elegir la muestra de individuos y así evitar posibles sesgos

indices <- sample(1:nrow(datos), size = 150, replace = FALSE) #Tomamos la muestra aleatoria de 150 individuos

muestra <- datos[indices, ] #Creamos el dataframe de esta nueva muestra de 150 individuos
```

<!--Realizamos un análisis descriptivo del tamaño de la cabeza para la muestra de 150 individuos seleccionando los datos relevantes (TABLA)-->

```{r}
tabla_kb <- muestra |>
  summarise(
    N = n(),
    Media = mean(KB, na.rm = TRUE),
    Q1 = quantile(KB, 0.25, na.rm = TRUE),
    Mediana = median(KB, na.rm = TRUE),
    Q3 = quantile(KB, 0.75, na.rm = TRUE),
    DE = sd(KB, na.rm = TRUE),
    IQR = IQR(KB, na.rm = TRUE),
    Min = min(KB, na.rm = TRUE),
    Max = max(KB, na.rm = TRUE)
  )

tabla_kb |>
  kable(
    col.names = c(
      "N", "Media", "Q1", "Mediana", "Q3",
      "Desv. típica", "IQR", "Mín", "Máx"
    ),
    caption = "Estadísticos descriptivos de la anchura de la cabeza (KB)",
    digits = 4,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )
```



```{r}
muestra |> ggplot(aes(KB)) +

  geom_histogram(
    aes(y = after_stat(density)),
    fill = "#A6C8E0", 
    color = "grey30",
    bins = 30,
    alpha = 0.7
  ) +
  geom_density(
    color = "#08306B",
    linewidth = 0.8,
    alpha = 0.5
  ) +
  
  labs(
    title = "Histograma de KB con curva de densidad",
    x = "KB (mm)",
    y = "Frecuencia"
  ) +
  
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.title = element_text(),
    axis.text = element_text(),
    panel.grid.major = element_line(color = "grey90"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey30", fill = NA, size = 0.8)
  )
```

El histograma representa la distribución de la anchura de la cabeza de nuestra muestra de 150 ejemplares. Presenta un pico (moda) alrededor de los 8,5mm y asimetría positiva, con una cola alargada hacia los valores más grandes, lo que implica que la mayoría de individuos presenta una anchura de cabeza pequeña y un número reducido alcanza valores mayores. Los estadísticos obtenidos en la tabla refuerzan este argumento ya que la media (12,15mm) es mayor a la mediana (10,8mm).

## Comparación de la anchura de la cabeza por sexos

```{r}
tabla_kb_sexo <- muestra |>
  group_by(SEXO) |>
  summarise(
    N = n(),
    Media = mean(KB, na.rm = TRUE),
    DE = sd(KB, na.rm = TRUE),
    Mediana = median(KB, na.rm = TRUE),
    IQR = IQR(KB, na.rm = TRUE),
)

tabla_kb_sexo |>
  kable(
    col.names = c("Sexo", "N", "Media", "Desv. típica", "Mediana", "IQR"),
    caption = "\ Estadísticos descriptivos de la anchura de la cabeza (KB) por sexo",
    digits = 4,
    booktabs = TRUE,
    align = "c",
    escape = FALSE   # permite que LaTeX interprete la caption
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )

```

```{r}
ggplot(muestra, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_boxplot(alpha = 0.6) +
  labs(
    title = "Anchura de la cabeza (KB) por sexo",
    x = "Sexo",
    y = "KB (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Tanto la Tabla 2 como el diagrama de caja muestran que los machos presentan una anchura de cabeza promedio mayor que las hembras, con una diferencia de 5,96mm. Además, los machos presentan mayor variabilidad, su desviación típica de 3,48 y IQR 4,9 frente a los 0,91 y 1,3 de las hembras indican mayor dispersión en los valores de los machos. Estas claras diferencias sugieren un marcado dimorfismo sexual en la anchura de la cabeza.


## Comparación de la anchura de la cabeza por provincias

```{r}
tabla_kb_provincia <- muestra |>
  group_by(PROVINCIA) |>
  summarise(
    N = n(),
    Media = mean(KB, na.rm = TRUE),
    DE = sd(KB, na.rm = TRUE),
    Mediana = median(KB, na.rm = TRUE),
    IQR = IQR(KB, na.rm = TRUE),
)

tabla_kb_provincia |>
  kable(
    col.names = c(
      "Provincia", "N", "Media",
      "Desv. típica", "Mediana", "IQR"
    ),
    caption = "Estadísticos descriptivos de la anchura de la cabeza (KB) por provincia",
    digits = 4,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position", "striped"),
    full_width = FALSE
  )
```


```{r}
ggplot(muestra, aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_boxplot(alpha = 0.6) +
  labs(
    title = "Anchura de la cabeza (KB) por provincia",
    x = "Provincia",
    y = "KB (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

\vspace{1cm}
En este análisis por provincia podemos observar que Asturias concentra la mayor parte de la muestra. Otras presenta la mayor media seguida por Cantabria, y los individuos de procedencia desconocida ligeramente mayor que los ejemplares con menos promedio de anchura de cabeza que son los de Asturias. La variabilidad es mayor en el grupo de Otras indicado por su mayor desviación típica y mayor IQR.

En el diagrama de cajas los valores de la anchura de la cabeza de las distintas provincias se sitúan en intervalos muy parecidos por lo que las diferencias son moderadas entre provincias.


## Correlación de la anchura de la cabeza y longitud de élitros

La siguiente gráfica representa el análisis comparativo de las dos características de la muestra completa.

```{r}
# Recta de regresión de la variable EL en función de KB
muestra |> 
  select(KB, EL) |>  # Selecciona las columnas 'EL' y 'KB'
  ggplot(aes(x=EL, y = KB)) +  # Define las variables para el gráfico
  geom_point(
    color = "grey40",
  ) +  # Añade puntos al gráfico
  theme_bw() +  # Aplica un tema en blanco y negro
  geom_smooth(
    method = lm, 
    se = TRUE,
    color = "darkgreen"
  )  # Añade una línea de regresión lineal sin intervalo de confianza
```


```{r}
# Creación y resumen de un modelo lineal para 'est' en función de 'mg'
modelo <- muestra |> 
  select(KB, EL) |>  # Selecciona las variables 'KB' y 'EL'
  with(lm(KB ~ EL))  # Crea un modelo lineal de 'KB' en función de 'EL'

#Valor de r^2
r2 <- summary(modelo)$r.squared
#r2

#Valor de r
r <- sign(coef(modelo)[2]) * sqrt(r2)
#r
```

```{r}
tabla_cor <- data.frame(
  r2 = r2,
  r = r
)

tabla_cor |>
  kable(
    col.names = c("Coeficiente de determinación (r²)", "Coeficiente de correlación (r)"),
    digits = 4,
    booktabs = TRUE,
    caption = "Valores de r² y r para la regresión KB - EL (todos los individuos)",
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position", "striped"),
    full_width = FALSE
  )

```

**Interpretación:** La correlación es fuerte al ser la r positiva cerca de 1. Además, el valor de la r^2 muestra que un 75,6% de la variabilidad de la variable KB se explica por los valores de la otra, EL, de nuevo reiterando la estrecha relación entre ellas.


## Correlación de la anchura de la cabeza y longitud de élitros por sexo

```{r}
# Recta de regresión de la variable 'est' en función de 'mg' filtrando por tipo 'C'
# 'filter(tipo == "C")' filtra el dataframe para incluir solo las filas donde la columna 'tipo' es igual a "C".
muestra |> 
  ggplot(aes(x = EL, y = KB)) +
  facet_wrap(~ SEXO) +
  geom_point(
    color = "grey40",
  ) +
  labs(
    x = "Longitud de los élitros (EL, mm)",
    y = "Anchura de la cabeza (KB, mm)",
    title = ""
  ) + 
  # 'geom_smooth(method = "lm")' añade una línea de ajuste lineal al gráfico. 'method = "lm"' indica que se usa un modelo lineal para el ajuste.
  geom_smooth(
    method = "lm",
    aes(color = SEXO)
  ) + 
  scale_color_manual(values = c("hembra" = "navy", "macho" = "darkred")) +
  theme_bw();

```


```{r}
modelo_hembra <- lm(
    KB ~ EL, 
    data = muestra, 
    subset = SEXO == "hembra"
)
modelo_macho <- lm(
    KB ~ EL, 
    data = muestra, 
    subset = SEXO == "macho"
)
#Valor de r^2 para la regresion lineal KB ~ EL para hembra y macho por separado
r2_hembra <- summary(modelo_hembra)$r.squared
r2_macho <- summary(modelo_macho)$r.squared

#Valor de r para la regresion lineal KB ~ EL para hembra y macho por separado
r_hembra <- sign(coef(modelo_hembra)[2]) * sqrt(r2_hembra)
r_macho <- sign(coef(modelo_macho)[2]) * sqrt(r2_macho)
```


```{r}
tabla_correlacion <- data.frame(
  Sexo = c("Hembra", "Macho"),
  r = c(r_hembra, r_macho),
  r2 = c(r2_hembra, r2_macho)
)

tabla_correlacion |>
  kable(
    col.names = c("Sexo", "Coeficiente de correlación (r)", "Coeficiente de determinación (r²)"),
    caption = "Coeficientes de correlación y determinación de la regresión KB y EL por sexo",
    digits = 4,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position", "striped"),
    full_width = FALSE,
    font_size = 10
  )

```

**Interpretación:** la correlación es muy fuerte tanto en el caso de las hembras como en el de los machos, mejora bastante al separarlo por sexos.

## Modelo de regresión lineal

```{r}
summary(modelo_hembra)$coefficients |>
  as.data.frame() |>
  kable(
    col.names = c(
      "Estimación",
      "Error estándar",
      "Estadístico t",
      "Valor p"
    ),
    caption = "Coeficientes del modelo de regresión lineal KB y EL para hembras",
    digits = 4,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position", "striped"),
    full_width = FALSE
  )

```


```{r}
muestra |> 
  filter(SEXO == "hembra") |> 
  ggplot(
    aes(x = EL, y = KB),
  ) +
  geom_point(
    color = "grey40"
  ) +
  geom_smooth(
    method = "lm",
    color = "navy"
  ) + 
  labs(
    x = "",
    y = "",
    title = "Modelo de regresión - Hembra",
  )
```


```{r}
par(mfrow = c(2, 2))
plot(modelo_hembra)
```

**Ecuación del modelo:**
¿?
La ecuación del modelo se obtiene de los valores de la tabla. Para hembras se tiene KB = -0.1333 + 0.4610*EL.

**Coeficiente determinación:**

**Interpretación:**

```{r}
summary(modelo_macho)$coefficients |>
  as.data.frame() |>
  kable(
    col.names = c(
      "Estimación",
      "Error estándar",
      "Estadístico t",
      "Valor p"
    ),
    caption = "Coeficientes del modelo de regresión lineal KB y EL para machos",
    digits = 4,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position", "striped"),
    full_width = FALSE
  )
```


```{r}
muestra |> 
  filter(SEXO == "macho") |> 
  ggplot(
    aes(x = EL, y = KB),
  ) +
  geom_point(
    color = "grey40"
  ) +
  geom_smooth(
    method = "lm",
    color = "darkred"
  ) + 
  labs(
    x = "",
    y = "",
    title = "Modelo de regresión - Macho",
  )
```
```{r}
par(mfrow = c(2, 2))
plot(modelo_macho)
```

**Ecuación del modelo:**
En este caso, la ecuación será KB = -13.604 + 1.2940*EL

**Coeficiente determinación:**


**Interpretación:**


\newpage
# Conclusiones

- 
-
-

\newpage
# Anexo:Código R


