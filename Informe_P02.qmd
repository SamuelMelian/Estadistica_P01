---
title: "Estudio de datos biométricos sobre el ciervo volante. Inferencia estadística."
author: 
  - "Olivia Marcos Diaz de Otazu"
  - "Irene Canales Giménez"
  - "Samuel Melián Benito"
date: "12/29/2025" 

format:
  pdf:
    toc: true
    toc-title: "Índice"
    toc-depth: 2
    include-before-body: 
    - text: \newpage
  
execute:
  echo: false
  warning: false
  message: false
  fig-align: center
    
geometry: margin=1in
include-in-header:
  - text: |
      \usepackage{fvextra}
      \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r librerias}
library(tidyverse)
library(summarytools)
library(GGally)
library(gt)
library(flextable)
library(knitr) 
library(corrplot)
library(ggplot2)
library(dplyr)   
library(kableExtra)
library(effsize)
library(ggstatsplot)
```

```{r lectura-datos}
datos <- read.table("./datos/CIERVO.txt", fill=TRUE, dec = ",", header=TRUE );

datos$SEXO <- factor(datos$SEXO, levels = c("hembra", "macho"))
datos$PROVINCIA <- factor(datos$PROVINCIA, levels = c("Asturias", "Cantabria", "Otras"))

datos <- datos |> dplyr::filter(!is.na(PROVINCIA))
summary(datos)
```
\newpage 
# Objetivo del estudio
Continuaremos el estudio de datos biométricos del **ciervo volante** (*Lucanus cervus*) estudiando los valores de anchura de cabeza (KB) y longitud de los élitros (EL), y sus diferencias dependiendo de su sexo y procedencia.

En base a las conclusiones obtenidas en la primera práctica de estadística descriptiva, comprobaremos, utilizando técnicas de inferencia si dichas conclusiones son estadísticamente significativas o sólo responden al azar.

El objetivo del estudio es responder a las siguentes preguntas:

1. ¿Entre qué valores fluctúa el promedio de la anchura de la cabeza y de la longitud de los élitros del Lucanus Cervus?
2. ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza y la longitud de los élitros según sexo?
3. ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza y la longitud de los élitros según si habitan en Cantabria o en Asturias?
4. Suponiendo que la muestra es representativa de la población, ¿los hábitats son igual de numerosos en Cantabria y Asturias?, ¿y en términos de sexo?


\newpage 
# Metodología
Para esta práctica de inferencia y contrastes de hipótesis, utilizaremos en todo momento el conjunto de datos al completo, es decir, los 250 individuos (dado que eliminamos los 15 con origen desconocido), en lugar de seleccionar una muestra aleatoria como se hizo en la práctica 1.

\newpage
# Análisis de resultados
## Pregunta 1. ¿Entre qué valores fluctúa el promedio de la anchura de la cabeza y de la longitud de los élitros del *Lucanus Cervus*?

```{r funcion-intervalo-confianza}
calcular_ic <- function(datos, alpha) {
  n <- length(datos) #Tamaño del dataset
  media <- mean(datos) #Media de los datos
  s <- sd(datos) #Desviación estándar de los datos
  t_critico <- qt(1 - alpha/2, df = n - 1) #valor crítico de la t-student (alpha es el nivel de confianza t n los grados de libertad de la t-student)
  error_estandar <- s / sqrt(n)
  ME <- t_critico * error_estandar
  c(media - ME, media + ME) #Intervalo de confianza
}
```

```{r intervalo-confianza-KB}
IC_KB <- calcular_ic(datos$KB, 0.05)
```

El intervalo de confianza al 95\% para la media de la **anchura de la cabeza (KB)** es:
\begin{center}
$[\,`r sprintf("%.2f", IC_KB[1])`,\;`r sprintf("%.2f", IC_KB[2])`\,]$ mm
\end{center}


Este primer cálculo del intervalo de confianza para el promedio de la anchura de la cabeza lo hemos realizado mediante la fórmula de intervalo de confianza para la media, siendo desconocida la desviación estándar poblacional. Recordemos que esta fórmula es
$$
IC = \overline{X} \pm t_{\frac{\alpha}{2},n-1}\cdot \left(\frac{s}{\sqrt{n}}\right) 
$$
\textbf{Interpretación}: Con un nivel de confianza del 95%, el promedio de la anchura de la cabeza de la \textbf{población} se encuentra en este intervalo obtenido.

```{r intervalo-confianza-EL}
IC_EL <- calcular_ic(datos$EL, 0.05)
```
El intervalo de confianza al 95\% para la media de la **longitud de los élitros (EL)** es:
\begin{center}
$[\,`r sprintf("%.2f", IC_EL[1])`,\;`r sprintf("%.2f", IC_EL[2])`\,]$ mm
\end{center}

\textbf{Interpretación}: Con un nivel de confianza del 95%, el promedio de la longitud de los élitros de la \textbf{población} se encuentra en este intervalo obtenido. Es decir, si repitiéramos el procedimiento con muchas muestras distintas, en el 95% de las ocasiones aproximadamente la media poblacional estaría en este intervalo de confianza.

## Pregunta 2.1 ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza según sexo?

Primero presentamos un resumen estadístico de la anchura de la cabeza para cada grupo (hembras y machos) con los datos de la muestra de 250 individuos.

```{r resumen-KB-sexo}
with(datos, stby(KB, SEXO, descr, stats = "common", transpose = TRUE))
```

Para poder responder esta pregunta tenemos que realizar un contraste de hipótesis para la igualdad de medias.

  Hipótesis nula ($H_0$): La media de KB es igual en ambos sexos.
  
  Hipótesis alternativa ($H_a$): La media de KB es diferente entre los dos sexos.

Para ello hacemos un test t de Student sobre la muestra de los machos y la muestra de las hembras. Concretamente haremos una prueba t de Welch, que se usa con dos muestras independientes cuando las varianzas no son iguales. Además, conviene su uso al ser las dos muestras de diferentes tamaños.


```{r contraste-KB-sexo}
test_KB_sexo = t.test(KB ~ SEXO, data = datos, var.equal = FALSE)

cohen_d <- cohen.d(KB ~ SEXO, data = datos, pooled = TRUE, hedges.correction = FALSE)

tabla_kb <- data.frame(
  t = unname(test_KB_sexo$statistic),
  gl = unname(test_KB_sexo$parameter),
  p_valor = test_KB_sexo$p.value,
  d_cohen = abs(cohen_d$estimate),
  IC_inf = test_KB_sexo$conf.int[1],
  IC_sup = test_KB_sexo$conf.int[2]
)
tabla_kb |>
  kable(
    col.names = c(
      "Estadístico t",
      "Grados de libertad",
      "p-Valor",
      "Tamaño del efecto (d de Cohen)",
      "Intervalo de confianza al 95% (inf)",
      "Intervalo de confianza al 95% (sup)"
    ),
    caption = "Test t de medias para KB por sexos",
    digits = 6,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )
```

AQUÍ HAY QUE SACAR CONCLUSIONES (ALGO DEL PALO : EXISTE DIFERENCIA SIGNIFICATIVA ENTRE LAS MEDIAS (P-VALOR < 0.001) DE LA ANCHURA DE LA CABEZA ENTRE MACHOS Y HEMBRAS. EL TAMAÑO DEL EFECTO ES MUY GRANDE (2.41), LO QUE INDICA DIMORFISMO SEXUAL MUY PRONUNCIADOL PARA MACHOS LA MEDIA DE KB ES... Y PARA HEMBRAS ES... (AL COMENTARLO ARRIBA CUANDO HACEMOS EL RESUMEN ESTADÍSTICO IGUAL ESTO ULTIMO DE LAS MEDIAS YA NO HACE FALTA AQUÍ))

**Interpretación:** existe diferencia significativa entre las medias de la anchura de la cabeza entre machos y hembras, el p-Valor es <0.001. El tamaño del efecto es muy grande, lo que indica dimorfismo sexual muy pronunciado. La media para machos es de 14.85mm y la de hembras 8.89mm.

En el siguiente gráfico se puede observar claramente la diferencia entre sexos:

```{r boxplot-KB-sexo}
#| fig.width: 7
#| fig.height: 5
#| fig-align: center
ggplot(datos, aes(x = SEXO, y = KB, fill = SEXO)) +
  geom_boxplot(
    alpha = 0.6,
    outlier.shape = 16) +
  geom_jitter(
    width = 0.15, 
    alpha = 0.6, 
    size = 1.5, 
    color = "grey40") +
  stat_summary(
    fun = mean,
    geom = "point",
    size = 4,
    color = "red"
  ) +
  labs(
    title = "Dimorfismo sexual en la anchura de la cabeza",
    x = "Sexo",
    y = "KB (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text  = element_text(size = 7)
  )
```

## Pregunta 2.2 ¿Existe diferencia estadísticamente significativa entre el promedio de la longitud de los élitros según sexo?
Primero presentamos un resumen estadístico de la longitud de los élitros para cada grupo (hembras y machos) con los datos de la muestra de 250 individuos.
```{r resumen-EL-sexo}
with(datos, stby(EL, SEXO, descr, stats = "common", transpose = TRUE))
```
Para resolver esta pregunta seguimos exactamente el mismo procedimiento, haciendo el t test esta vez para la variable EL.
```{r contraste-EL-sexo}
test_EL_sexo = t.test(EL ~ SEXO, data = datos, var.equal = FALSE)

cohen_d <- cohen.d(EL ~ SEXO, data = datos, pooled = TRUE, hedges.correction = FALSE)

tabla_el <- data.frame(
  t = unname(test_EL_sexo$statistic),
  gl = unname(test_EL_sexo$parameter),
  p_valor = test_EL_sexo$p.value,
  d_cohen = abs(cohen_d$estimate),
  IC_inf = test_EL_sexo$conf.int[1],
  IC_sup = test_EL_sexo$conf.int[2]
)
tabla_el |>
  kable(
    col.names = c(
      "Estadístico t",
      "Grados de libertad",
      "p-Valor",
      "Tamaño del efecto (d de Cohen)",
      "Intervalo de confianza al 95% (inf)",
      "Intervalo de confianza al 95% (sup)"
    ),
    caption = "Test t de medias para EL por sexos",
    digits = 6,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )
```

**Interpretación:** existe diferencia significativa entre las medias de la longitud de los élitros entre machos y hembras, el p-Valor es <0.001. El tamaño del efecto no es tan grande como para la anchura de la cabeza, con lo cual no existe tanta diferencia como en la anterior pero si que hay diferencia.

En el siguiente gráfico se puede observar la diferencia entre sexos:

```{r boxplot-EL-sexo}
#| fig.width: 7
#| fig.height: 5
#| fig-align: center
ggplot(datos, aes(x = SEXO, y = EL, fill = SEXO)) +
  geom_boxplot(
    alpha = 0.6,
    outlier.shape = 16) +
  geom_jitter(
    width = 0.15, 
    alpha = 0.6, 
    size = 1.5, 
    color = "grey40") +
  stat_summary(
    fun = mean,
    geom = "point",
    size = 4,
    color = "red"
  ) +
  labs(
    title = "Dimorfismo sexual en longitud de los élitros",
    x = "Sexo",
    y = "EL (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text  = element_text(size = 7)
  )
```

AQUI NO HAY QUE DECIR NADA

## Pregunta 3.1 ¿Existe diferencia estadísticamente significativa entre el promedio de la anchura de la cabeza según si habitan en Cantabria o en Asturias?

Primero presentamos un resumen estadístico de la anchura de la cabeza para cada procedencia geográfica con los datos de la muestra de 250 individuos.

```{r resumen-KB-provincia}
with(datos, stby(KB, PROVINCIA, descr, stats = "common", transpose = TRUE))
```

Al igual que en el apartado anterior, para responder esta pregunta podríamos realizar un contraste de hipótesis para la igualdad de medias teniendo en cuenta solo el subconjunto de Asturias y de Cantabria.

  Hipótesis nula ($H_0$): La media de KB es igual en ambas provincias.
  
  Hipótesis alternativa ($H_a$): La media de KB es diferente entre las dos provincias.

Para ello haríamos un test t de de Student, concretamente haremos una prueba t de Welch. No obstante, para ir algo más allá y ofrecer algún resultado adicional, podemos realizar un test ANOVA para entre otras cosas, poder obtener conclusiones sobre la pregunta planteada. Ahora el contraste es:
  $H_0$: La media de la anchura de la cabeza los 3 grupos es igual.
    $H_1$: Al menos una media es distinta.


```{r contraste-KB-provincia}
anova_KB <- aov(KB ~ PROVINCIA, data = datos)

res_anova <- summary(anova_KB)[[1]]

tabla_anova_KB <- data.frame(
  est_f = res_anova["PROVINCIA", "F value"],
  gl_1 = res_anova["PROVINCIA", "Df"],    
  gl_2 = res_anova["Residuals", "Df"],
  p = res_anova["PROVINCIA", "Pr(>F)"]
)

tabla_anova_KB |>
  kable(
    col.names = c(
      "Estadístico F",
      "Grados de libertad entre grupos",
      "Grados de libertad dentro de grupos (residuales)",
      "p-Valor"
    ),
    caption = "ANOVA de un factor para la anchura de la cabeza (KB) según procedencia geográfica",
    digits = 6,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )

```
Una vez hecho el test ANOVA, podemos hacer la prueba Tukey HSD (post-hoc) para identificar los pares específicos cuyas medias difieren.
```{r comparacion-KB-pares}
tuk <- TukeyHSD(anova_KB, which = "PROVINCIA")
tuk_tab <- as.data.frame(tuk$PROVINCIA)
tuk_tab$Comparación <- rownames(tuk_tab)
rownames(tuk_tab) <- NULL

tuk_tab <- tuk_tab |>
  dplyr::select(Comparación, diff, lwr, upr, `p adj`)

tuk_tab |>
  knitr::kable(
    col.names = c("Comparación", "Diferencia medias", "IC 95% (inf)", "IC 95% (sup)", "p-Valor ajustado"),
    digits = 6,
    booktabs = TRUE,
    align = "c",
    caption = "Comparaciones múltiples (Tukey HSD) para KB por provincia"
  ) |>
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped"),
    font_size = 9
  )

```
El p-valor que hemos obtenido en el análisis de varianza de un factor (ANOVA) es elevado
($p = 0.265699$), por lo que no se rechaza la hipótesis nula de igualdad de medias.
En consecuencia, no se detectan diferencias estadísticamente significativas en la
anchura de la cabeza entre las tres procedencias geográficas
(Asturias, Cantabria y Otras). Además, los resultados del análisis de comparaciones múltiples nos permiten ver que particularmente tampoco hay diferencias de medias estadísticamente significativas entre \textbf{Asturias y Cantabria}, lo que refuerza la conclusión anterior.


```{r boxplot-KB-provincia}
#| fig.width: 7
#| fig.height: 5
#| fig-align: center
ggplot(datos, aes(x = PROVINCIA, y = KB, fill = PROVINCIA)) +
  geom_boxplot(
    alpha = 0.6,
    outlier.shape = 16) +
  geom_jitter(
    width = 0.15, 
    alpha = 0.6, 
    size = 1.5, 
    color = "grey40") +
  stat_summary(
    fun = mean,
    geom = "point",
    size = 4,
    color = "red"
  ) +
  labs(
    title = "Anchura de la cabeza por procedencia geográfica",
    x = "Provincia",
    y = "KB (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text  = element_text(size = 7)
  )
```

## Pregunta 3.2 ¿Existe diferencia estadísticamente significativa entre la longitud de los élitros según si habitan en Cantabria o en Asturias?

Primero presentamos un resumen estadístico de la longitud de los élitros para cada procedencia geográfica con los datos de la muestra de 250 individuos.

```{r resumen-EL-provincia}
with(datos, stby(KB, PROVINCIA, descr, stats = "common", transpose = TRUE))
```

De nuevo, hacemos un test ANOVA y un análisis post hoc de Tukey para confirmar el resultado, esta vez para la variable EL.


```{r contraste-EL-provincia}
anova_EL <- aov(EL ~ PROVINCIA, data = datos)

res_anova <- summary(anova_EL)[[1]]

tabla_anova_EL <- data.frame(
  est_f = res_anova["PROVINCIA", "F value"],
  gl_1 = res_anova["PROVINCIA", "Df"],    
  gl_2 = res_anova["Residuals", "Df"],
  p = res_anova["PROVINCIA", "Pr(>F)"]
)

tabla_anova_EL |>
  kable(
    col.names = c(
      "Estadístico F",
      "Grados de libertad entre grupos",
      "Grados de libertad dentro de grupos (residuales)",
      "p-Valor"
    ),
    caption = "ANOVA de un factor para la longitud de los élitros (EL) según procedencia geográfica",
    digits = 6,
    booktabs = TRUE,
    align = "c"
  ) |>
  kable_styling(
    latex_options = c("hold_position","striped"),
    font_size = 10
  )

```


```{r comparacion-EL-pares}
tuk <- TukeyHSD(anova_EL, which = "PROVINCIA")
tuk_tab <- as.data.frame(tuk$PROVINCIA)
tuk_tab$Comparación <- rownames(tuk_tab)
rownames(tuk_tab) <- NULL

tuk_tab <- tuk_tab |>
  dplyr::select(Comparación, diff, lwr, upr, `p adj`)

tuk_tab |>
  knitr::kable(
    col.names = c("Comparación", "Diferencia medias", "IC 95% (inf)", "IC 95% (sup)", "p-Valor ajustado"),
    digits = 6,
    booktabs = TRUE,
    align = "c",
    caption = "Comparaciones múltiples (Tukey HSD) para EL por provincia"
  ) |>
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped"),
    font_size = 9
  )

```
De nuevo, el análisis de varianza de un factor no muestra diferencias estadísticamente
significativas en la longitud de los élitros entre las procedencias geográficas
($p = 0.250791$). El análisis post hoc de Tukey confirma el resultado, ya que
ninguna de las comparaciones por pares presenta un p-valor ajustado inferior a
$0.05$, incluyendo la comparación entre \textbf{Asturias y Cantabria}.


```{r boxplot-EL-provincia}
#| fig.width: 7
#| fig.height: 5
#| fig-align: center
ggplot(datos, aes(x = PROVINCIA, y = EL, fill = PROVINCIA)) +
  geom_boxplot(
    alpha = 0.6,
    outlier.shape = 16) +
  geom_jitter(
    width = 0.15, 
    alpha = 0.6, 
    size = 1.5, 
    color = "grey40") +
  stat_summary(
    fun = mean,
    geom = "point",
    size = 4,
    color = "red"
  ) +
  labs(
    title = "Longitud de los élitros por procedencia geográfica",
    x = "Provincia",
    y = "EL (mm)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text  = element_text(size = 7)
  )
```

## Pregunta 4. Suponiendo que la muestra es representativa de la población, ¿los hábitats son igual de numerosos en Cantabria y Asturias?, ¿y en términos de sexo?

\newpage 
# Resumen de resultados y conclusiones

PARA EL RESUMEN DE RESULTADOS HACER UNA TABLA CON LA PREGUNTA EN PLAN (2.1 KB Y SEXO), estadistico t, ... , EL P VALOR Y EL RESULTADO.

**Conclusiones**
Dimorfismo sexual pronunciado:
Ausencia de variación geográfica:
Patrones alométricos diferenciados:
Implicaciones evolutivas:

IMPORTANTE COMPARAR CON PRACTICA 1

\newpage 
# Anexo: Código R